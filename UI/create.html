<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name= "viewport" content= "width=device-width, initial-scale=1.0">
  <title>iReporter</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="db-body">
  <header>
    <nav>
      <div class="nav-header">
        <div class="logo">
          <a href="#"><span class="logo-i">i</span>REPORTER</a>
        </div>

        <div class="">
          <ul class="nav-menu">
            <li><a href=""><button class="menu-btn logout">Logout</button></a></li>
          </ul>

          <!-- <div class="nav-icon" onclick= menu();> -->
          <div class="nav-icon" onclick="openNav()";>
            <span class="navs">&#9776</span>
          </div>
        </div>
      </div>

      <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <h2 class="user-name"><span class="data"></span></h2>
        <a href="profile.html">Profile</a>
        <a href="create.html">Add Record</a>
        <a href="draft.html">My Drafts</a>
        <a href=""><button class="menu-btn logout">Logout</button></a>
      </div>
    </nav>
  </header>

  <main>
    <div class="db-sidenav">
      <section>
        <h2 class="user-name"><i class="fa fa-user-circle"></i><br><span class="data"></span></h2>
        <ul>
          <li class="nav-list"><a href="profile.html"><i class="fa fa-user-o"></i>Profile</a></li>
          <li class="nav-list"><a href="create.html"><i class="fa fa-plus"></i>Add Record</a></li>
          <li class="nav-list"><a href="draft.html"><i class="fa fa-envelope-open-o"></i>My Drafts</a></li>
          <li class="nav-list logout"><a href=""><i class="fa fa-sign-out"></i>Logout</a></li>
        </ul>
      </section>
    </div>

    <div class="main-div">
      <h1 class="db-header">iREPORTER DASHBOARD</h1><hr>

      <section class="db-table">
        <h2 class="table-header">Create Record</h2>

    <form action="" id="recordForm">
          <label for="" class="form-info">*CREATE A RED FLAG OR INTERVENTION RECORD</label>
          <input type="text" placeholder="TITLE OF RECORD" id="title" name="title">
          <textarea placeholder="WRITE A RECORD..." rows="10" id="comment" name="comment"></textarea><br>
          <input type="radio" name="type" value="redFlag" checked=""> Red flag Record<br>
          <input type="radio" name="type" value="intervention"> Intervention Record<br><br>
          <input id="geo-data" type="text" disabled="" required placeholder="GEOLOCATION" name="location" class="location">
          <input id="geo-btn" type="button" value="Get Geolocation"><br><br><br>

          <label>Select an image: </label><br>
          <input type="file" name="image" id="image">

          <div class="userMsg-wrapper">
            <div id="returnMsg"></div>
          </div>

          <input type="submit" value="SUBMIT" id="recordBtn">
        </form>

      </section>

    </div>

    <div class="clear"></div>
  </main>

  <footer>
    <div class="logo">
      <a href="#"><span class="logo-i">i</span>REPORTER</a>
    </div>
    <p class="footer-para">All rights reserved &copy; 2018</p>
  </footer>

  <script src="js/script.js"></script>
  <script>
    let logout = document.querySelectorAll('.logout');
    for (let i = 0; i < logout.length; i++) {
      logout[i].onclick = (e) => {
        e.preventDefault();
        localStorage.clear();
        location.href = 'login.html';
      }
    }

    geoBtn.onclick = () => {
      if ( navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {

          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          const myRequest = new Request('https://maps.googleapis.com/maps/api/geocode/json?latlng=' + lat + ',' + lng + '&key=AIzaSyAMBlwdnO6grtZ88dwLJy42Qw1PMumqI9U');

          fetch(myRequest, {
            headers: {
            'Accept': 'application/json, application/xml, text/plain, text/html, *.*',
            'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
            },
            method: 'GET'
          })
          .then(response => {
            return response.json();
          })
          .then(data => {
            geoData.value = data.plus_code.compound_code;
          })
          .catch(err => {
            console.log('this is error' + err)
          })
        })
      }
    }

    const returnMsg = document.getElementById('returnMsg');

    const userName = document.querySelector('.data');

    const objUser = JSON.parse(localStorage.user);
    const token = objUser.token
    const firstName = objUser.firstName
    const lastName = objUser.lastName

    userName.textContent = firstName + ' ' + lastName;


    const myForm = document.getElementById('recordForm');
    const recordLocation = document.querySelector('.location');

    myForm.addEventListener('submit', function(e){
      e.preventDefault();

      const recordType = document.querySelector('input[name=type]:checked');
      let url = '';

      if (recordType.value === 'intervention') {
        url = 'https://andela-ireporter.herokuapp.com/api/v1/interventions';
      } else {
        url = 'https://andela-ireporter.herokuapp.com/api/v1/red-flags';
      }

      recordLocation.disabled = false;
      const formData = new FormData(this);
      const myRequest = new Request(url);

      fetch(myRequest, {
        method: 'post',
        headers: {
        'x-access-token': token
        },
        body: formData
      })
      .then(response => {
        return response.json();
      })
      .then(data => {
        recordLocation.disabled = true;
        returnMsg.className = 'userMsg';

        if(data.status === 201){
          returnMsg.style.background = 'green';
          returnMsg.textContent = data.data[0].message;
        } else {
          returnMsg.style.background = 'red';
          returnMsg.textContent = data.message;
        }
      })
      .catch(error => {
        console.error(error)
      })

      this.reset();

    })
  </script>

</body>
</html>