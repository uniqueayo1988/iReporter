<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name= "viewport" content= "width=device-width, initial-scale=1.0">
  <title>iReporter</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="db-body">
  <header>
    <nav>
      <div class="nav-header">
        <div class="logo">
          <a href="#"><span class="logo-i">i</span>REPORTER</a>
        </div>

        <div class="">
          <ul class="nav-menu">
            <li><a href=""><button class="menu-btn logout">Logout</button></a></li>
          </ul>

          <div class="nav-icon" onclick="openNav()";>
            <span class="navs">&#9776</span>
          </div>
        </div>
      </div>

      <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <h2 class="user-name">Admin</h2>
        <a href="#">Home</a>
        <a href=""><button class="menu-btn logout">Logout</button></a>
      </div>
    </nav>
  </header>

  <main>
    <div class="db-sidenav">
      <section>
        <h2 class="user-name"><i class="fa fa-user-circle"></i><br>Admin</h2>
        <ul>
          <li class="nav-list"><a href="#"><i class="fa fa-home"></i>Home</a></li>
          <li class="nav-list logout"><a href=""><i class="fa fa-sign-out"></i>Logout</a></li>
        </ul>
      </section>
    </div>

    <div class="main-div">
      <h1 class="db-header">ADMIN DASHBOARD</h1><hr>

      <section class="db-table">
        <h2 class="table-header">User Records</h2>

        <div style="overflow-x:auto;">
          <div style="float: right;">
            <button class="menu-btn tb-btn showRecord" onclick="showRecord()"><i class="fa fa-plus tb-fa"></i>Red flags</button>
            <button class="menu-btn tb-btn showInt" onclick="showInt()"><i class="fa fa-plus tb-fa"></i>Interventions</button>
          </div>
          <table id="userRedflag">

          </table>

          </table>

          <table id="userIntervention"></table>
        </div>

      </section>

    </div>

    <div class="clear"></div>
  </main>

  <footer>
    <div class="logo">
      <a href="#"><span class="logo-i">i</span>REPORTER</a>
    </div>
    <p class="footer-para">All rights reserved &copy; 2018</p>
  </footer>

  <script src="../js/script.js"></script>

  <script>
    let logout = document.querySelectorAll('.logout');
    for (let i = 0; i < logout.length; i++) {
      logout[i].onclick = (e) => {
        e.preventDefault();
        localStorage.clear();
        location.href = '../login.html';
      }
    }

    const objUser = JSON.parse(localStorage.user);
    const token = objUser.token

    const userIntervention = document.getElementById('userIntervention')

    const myRequest = new Request('https://andela-ireporter.herokuapp.com/api/v1/interventions/users');

    fetch(myRequest, {
      method: 'GET',
      headers: {
        'x-access-token': token
      },
    })
    .then(response => {
      return response.json();
    })
    .then(data => {

      let tRows = document.createElement('tr');
      tRows.className = 'tr-header';

      let tHeads = '';
      tHeads += '<th>S/N</th>';
      tHeads += '<th>Record</th>';
      tHeads += '<th>Location</th>';
      tHeads += '<th>Type</th>';
      tHeads += '<th>Status</th>';
      tHeads += '<th>Update Status</th>';

      tRows.innerHTML = tHeads;

      userIntervention.appendChild(tRows);


      for (let i = 0; i < data.data.length; i++) {
        let tabRow = document.createElement('tr');
        let tCol = '';
        let num = 1;
        num+=i;

        tCol += '<td>' + num + '</td>';
        let date = new Date(data.data[i].createdon);
        let stringDate = date.toDateString();
        tCol += '<td><a href="record.html?id=' + data.data[i].id + '&type=interventions"><h3 class="tr-header">' + data.data[i].title + '</h3><p>' + data.data[i].comment + '<br><span class="tb-date">' + stringDate + ' - Userid: ' + data.data[i].createdby + '</span></p></a></d>'
        tCol += '<td>' + data.data[i].location + '</td>';
        tCol += '<td>' + data.data[i].type + '</td>';
        tCol += '<td class="statusUpdate">' + data.data[i].status + '</td>';
        tCol += '<td><select class="status" name="' + data.data[i].id + '"><option>draft</option><option>resolved</option><option>under investigation</option><option>rejected</option></select></td>'
        tabRow.innerHTML = tCol;
        userIntervention.appendChild(tabRow);
      }

      let statusUpdate = document.querySelectorAll('.statusUpdate');
      let val = document.querySelectorAll('.status')
      for (let i = 0; i < val.length; i++) {
        val[i].onchange = (e) => {
          let id = e.currentTarget.name;
          let status = e.currentTarget.value;

          statusUpdate[i].textContent = status;

          const myRequests = new Request('https://andela-ireporter.herokuapp.com/api/v1/interventions/' + id + '/status');
          fetch(myRequests, {
            headers: {'Content-Type': 'application/json', 'x-access-token': token},
            method: 'PATCH',
            body: JSON.stringify({
              status: status
            })
          })
          .then(response => {
            return response.json();
          })
          .then(data => {
            console.log(data.data);
          })

        }
      }
    })

    const userRedflag = document.getElementById('userRedflag')

    const urlRequest = new Request('https://andela-ireporter.herokuapp.com/api/v1/red-flags/users');

    fetch(urlRequest, {
      method: 'GET',
      headers: {
        'x-access-token': token
      },
    })
    .then(response => {
      return response.json();
    })
    .then(data => {
      let tRows = document.createElement('tr');
      tRows.className = 'tr-header';

      let tHeads = '';
      tHeads += '<th>S/N</th>';
      tHeads += '<th>Record</th>';
      tHeads += '<th>Location</th>';
      tHeads += '<th>Type</th>';
      tHeads += '<th>Status</th>';
      tHeads += '<th>Update Status</th>';

      tRows.innerHTML = tHeads;

      userRedflag.appendChild(tRows);


      for (let i = 0; i < data.data.length; i++) {
        let tabRow = document.createElement('tr');
        let tCol = '';
        let num = 1;
        num+=i;

        tCol += '<td>' + num + '</td>';
        let date = new Date(data.data[i].createdon);
        let stringDate = date.toDateString();
        tCol += '<td><a href="record.html?id=' + data.data[i].id + '&type=red-flags"><h3 class="tr-header">' + data.data[i].title + '</h3><p>' + data.data[i].comment + '<br><span class="tb-date">' + stringDate + ' - Userid: ' + data.data[i].createdby + '</span></p></a></d>'
        tCol += '<td>' + data.data[i].location + '</td>';
        tCol += '<td>' + data.data[i].type + '</td>';
        tCol += '<td class="redflagUpdate">' + data.data[i].status + '</td>';
        tCol += '<td><select class="redflagStatus" name="' + data.data[i].id + '"><option>draft</option><option>resolved</option><option>under investigation</option><option>rejected</option></select></td>'
        tabRow.innerHTML = tCol;
        userRedflag.appendChild(tabRow);
      }

      let statusUpdate = document.querySelectorAll('.redflagUpdate');
      let val = document.querySelectorAll('.redflagStatus')
      for (let i = 0; i < val.length; i++) {
        val[i].onchange = (e) => {
          let id = e.currentTarget.name;
          let status = e.currentTarget.value;

          statusUpdate[i].textContent = status;

          const myRequests = new Request('https://andela-ireporter.herokuapp.com/api/v1/red-flags/' + id + '/status');
          fetch(myRequests, {
            headers: {'Content-Type': 'application/json', 'x-access-token': token},
            method: 'PATCH',
            body: JSON.stringify({
              status: status
            })
          })
          .then(response => {
            return response.json();
          })
          .then(data => {
            console.log(data.data);
          })

        }
      }
    })

    userRedflag.style.display = "table";
    userIntervention.style.display = "none";

    let showRecord = () => {
      if (userRedflag.style.display == "none") {
        userRedflag.style.display = "table";
        userIntervention.style.display = "none";
      }
    }

    let showInt = () => {
      if (userIntervention.style.display == "none") {
        userRedflag.style.display = "none";
        userIntervention.style.display = "table";
      }
    }

  </script>
</body>
</html>