<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name= "viewport" content= "width=device-width, initial-scale=1.0">
  <title>iReporter</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="db-body">
  <header>
    <nav>
      <div class="nav-header">
        <div class="logo">
          <a href="#"><span class="logo-i">i</span>REPORTER</a>
        </div>

        <div class="">
          <ul class="nav-menu">
            <li><a href=""><button class="menu-btn logout">Logout</button></a></li>
          </ul>

          <div class="nav-icon" onclick="openNav()";>
            <span class="navs">&#9776</span>
          </div>
        </div>
      </div>

      <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <h2 class="user-name">Admin</h2>
        <a href="index.html">Home</a>
        <a href=""><button class="menu-btn logout">Logout</button></a>
      </div>
    </nav>
  </header>

  <main>
    <div class="db-sidenav">
      <section>
        <h2 class="user-name"><i class="fa fa-user-circle"></i><br>Admin</h2>
        <ul>
          <li class="nav-list"><a href="index.html"><i class="fa fa-home"></i>Home</a></li>
          <li class="nav-list logout"><a href=""><i class="fa fa-sign-out"></i>Logout</a></li>
        </ul>
      </section>
    </div>

    <div class="main-div">
      <h1 class="db-header">ADMIN DASHBOARD</h1><hr>

      <section class="db-content">

      </section>

      <div class="statusContainer" style="width: 80%; margin:auto; padding: 20px 0;">
        <button id="statusBtn"></button>
        <select id="status">
          <option value="">Update status</option>
          <option>draft</option>
          <option>resolved</option>
          <option>rejected</option>
          <option>under investigation</option>
        </select>
      </div>

    </div>

    <div class="clear"></div>
  </main>

  <footer>
    <div class="logo">
      <a href="#"><span class="logo-i">i</span>REPORTER</a>
    </div>
    <p class="footer-para">All rights reserved &copy; 2018</p>
  </footer>

  <script src="../js/script.js"></script>

  <script>
    let logout = document.querySelectorAll('.logout');
    for (let i = 0; i < logout.length; i++) {
      logout[i].onclick = (e) => {
        e.preventDefault();
        localStorage.clear();
        location.href = '../login.html';
      }
    }

    const objUser = JSON.parse(localStorage.user);
    const token = objUser.token

    const url_string = location.href;
    const url = new URL(url_string);
    const id = url.searchParams.get('id');
    const type = url.searchParams.get('type');

    let sectionContent = document.querySelector('.db-content');

    let statusBtn = document.getElementById('statusBtn');

    const myRequest = new Request('https://andela-ireporter.herokuapp.com/api/v1/' + type + '/' + id + '/user');

    fetch(myRequest, {
      method: 'GET',
      headers: {
        'x-access-token': token
      },
    })
    .then(response => {
      return response.json();
    })
    .then(data => {
      console.log(data.data)
      let recordHeader = document.createElement('h2');
      recordHeader.className = 'record-header';
      recordHeader.textContent = data.data[0].title.toUpperCase();

      let spanRecord = document.createElement('span');
      spanRecord.className = 'record-name'

      let date = new Date(data.data[0].createdon);
      let stringDate = date.toDateString();
      spanRecord.textContent = stringDate + ' - Userid: ' + data.data[0].createdby;

      let recordImg = document.createElement('img');
      recordImg.setAttribute('src', 'https://andela-ireporter.herokuapp.com/' + data.data[0].image + '')
      recordImg.setAttribute('alt', 'Record Image')

      let recordDiv = document.createElement('div');
      recordDiv.innerHTML = '<br>' + data.data[0].comment;

      sectionContent.appendChild(recordHeader)
      sectionContent.appendChild(spanRecord)
      sectionContent.appendChild(recordImg)
      sectionContent.appendChild(recordDiv)

      statusBtn.textContent = data.data[0].status
    })

    let status = document.getElementById('status');

    status.onchange = () => {
      const statusUpdate = status.value;
      if (statusUpdate) {
        statusBtn.textContent = statusUpdate.toUpperCase()

        const myRequests = new Request('https://andela-ireporter.herokuapp.com/api/v1/' + type + '/' + id + '/status');

        fetch(myRequests, {
          headers: {'Content-Type': 'application/json', 'x-access-token': token},
          method: 'PATCH',
          body: JSON.stringify({
            status: statusUpdate
          })
        })
        .then(response => {
          return response.json();
        })
        .then(data => {
          console.log(data.data);
        })
        .catch(err => {
          console.log('this is error ' + err)
        })

      }
    }

  </script>
</body>
</html>